
<style type="text/css">

    #win-config {padding:15px;}
    .config-tabs {width:100%;overflow: hidden;}
    .tabs-nav {overflow: hidden;}
    .tabs-nav li {float:left;width:50%; height:30px;background:#e1e1e1;text-align: center;line-height:30px;color:#333;cursor:pointer;}
    .tabs-nav li:nth-of-type(1) {border-radius: 5px 0 0 0;}
    .tabs-nav li:nth-of-type(2) {border-radius: 0 5px 0 0;}
    .tabs-nav li.active {background: #52AAD6;color: #fff;font-weight: bold;}

    .tabs-content li {display:none;float:left;width:100%;overflow: hidden;height: 300px;}
    .tabs-content li.active {display:block;}

    .top-box {height: 270px;background-color: #f5f5f5;overflow: auto;}
    .bottom-box {height: 30px;border-radius: 0 0 5px 5px;background:#eee;text-align:center;}
    .bottom-box a {padding: 2px 15px;border: 1px solid #666;cursor:pointer;border-radius: 8px;color: #333;margin: 5px;display: inline-block;background:#fff;}
    .bottom-box a:hover {background:#f1f1f1;}

    li .item {float:left;width:27%;margin:8px 0;padding:0 10px;}
    li .item input[type="checkbox"] {position:relative;top:3px;margin-right:3px;width:14px;height:14px;}
</style>

<div class="wrap">
    <div id="rbac-toolbar">
        <a id="btn-rbac-create" href="#" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true">添加</a>
        <a id="btn-rbac-update" href="#" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true">修改</a>
        <a id="btn-rbac-remove" href="#" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true">删除</a>
        <a id="btn-rbac-config" href="#" class="easyui-linkbutton" data-options="iconCls:'icon-edit',plain:true">设置</a>
    </div>
    <table id="rbac"></table>
    <div id="win-operate"></div>
    <div id="win-rbac-user" style="padding:5px;">
        <table id="rbac-user"></table>
        <div id="rbac-user-toolbar">
            <a id="btn-user-submit">确定</a>
        </div>
    </div>

    <div id="win-config">
        <div class="config-tabs">
            <ul class="tabs-nav">
                <li class="active" data-id="0">用户</li>
                <li data-id="1">权限</li>
            </ul>

            <ul class="tabs-content">
                <li class="active">
                    <div class="top-box">
                    </div>
                    <div class="bottom-box">
                        <a id="btn-user-add">添加</a>
                        <a id="btn-user-remove">删除</a>
                    </div>
                </li>
                <li>
                    <div class="top-box">
                        <div class="item"><input type="checkbox"><span>读文章</span></div>
                        <div class="item"><input type="checkbox"><span>评论</span></div>
                        <div class="item"><input type="checkbox"><span>回复</span></div>
                        <div class="item"><input type="checkbox"><span>搜索</span></div>
                        <div class="item"><input type="checkbox"><span>个人日记</span></div>
                    </div>
                    <div class="bottom-box">
                        <a id="btn-permission-add">添加</a>
                        <a id="btn-permission-remove">删除</a>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</div>


<script type="text/javascript">

    var currentRole = "";
    $(function() {
        //加载对话框
        loadDialog();

        //加载Datagird
        loadDatagrid();

        //处理tabs
        handleTabs();

        //事件监听
        listenerEvent();
        $("#btn-user-submit").linkbutton({
            iconCls: 'icon-ok'
        });
    });


    /**
     * 加载角色下面的用户
     */
    function loadUsers() {
        $.ajax({
            type:"post",
            dataType:"json",
            data:{roleName:currentRole.roleName},
            url:"/rbac/getUsers",
            async:false,
            success:function(data) {
                if(data) {
                    var $box = $(".tabs-content li:eq(0) .top-box");
                    $box.empty();
                    var elems = [];
                    data.forEach(function(item) {
                        elems.push($('<div class="item"><input type="checkbox"><span>'+item+'</span></div>'))
                    })
                    $box.append(elems);
                }
            }
        });
    }

    function submitUsers(users) {
        $.ajax({
            type:"post",
            dataType:"text",
            data:{users:users,_id:currentRole._id},
            url:"/rbac/submitUsers",
            async:false,
            success:function(data) {
                if(data && data=="success") {
                    loadUsers();
                }
            }
        });
    }


    /**
     * 事件监听
     */
    function listenerEvent() {
        //设置
        $("#btn-rbac-config").click(function() {
            var selectedItem = $("#rbac").datagrid("getSelected");
            if(selectedItem && selectedItem._id) {
                currentRole = selectedItem;
                $("#win-config").dialog("open");
                loadUsers(selectedItem.roleName);
            }
        });

        //添加
        $("#btn-user-add").click(function() {
            $("#win-rbac-user").dialog("open");
        });

        //删除
        $("#btn-user-remove").click(function() {
            var users = [];
            $(".tabs-content li.active .top-box .item").each(function(i,e) {
                if($(this).find("input[type='checkbox']").is(":checked")){ //jQuery方式判断
                    users.push($(this).find("span").text());
                }
            });

            if(users && users.length>0) {
                $.ajax({
                    type:"post",
                    dataType:"text",
                    data:{users:users,_id:currentRole._id},
                    url:"/rbac/removeUsers",
                    async:false,
                    success:function(data) {
                        if(data && data=="success") {
                            loadUsers();
                        }
                    }
                });
            }
        });



        $("#btn-user-submit").click(function() {
            var selectedItems = $('#rbac-user').datagrid("getSelections");
            if(selectedItems && selectedItems.length>0) {
                var users = [];
                selectedItems.forEach(function(item) {
                    users.push(item.username);
                })
                submitUsers(users);
            }
            $("#win-rbac-user").dialog("close");
        });
    }

    /**
     * 处理tabs
     */
    function handleTabs() {
        $(".config-tabs li").click(function() {
            $(this).siblings().removeClass("active").end().addClass("active");
            $(".tabs-content li").eq($(this).attr("data-id")).addClass("active").siblings().removeClass("active");
        });
    }

    /**
     * 加载对话框
     */
    function loadDialog() {
        $("#win-config").dialog({
            title: '配置权限',
            width: 500,
            height: 400,
            closed: false,
            cache: false,
            modal: true
        });
        $("#win-config").dialog("close");
        $("#win-rbac-user").dialog({
            title: '选择用户',
            width: 505,
            height: 450,
            closed: false,
            cache: false,
            modal: true
        });
        $("#win-rbac-user").dialog("close");
    }


    /**
     * 加载Datagrid
     */
    function loadDatagrid() {
        $('#rbac').datagrid({
            width:250,
            height:300,
            url:'/rbac/list',
            toolbar:"#rbac-toolbar",
            singleSelect:true,
            columns:[[
                {field:'_id',checkbox:true},
                {field:'roleName',title:"角色名",width:220,align:"center"}
            ]]
        });
        $('#rbac-user').datagrid({
            width:480,
            height:400,
            url:'/user/getList?keywords=',
            toolbar:"#rbac-user-toolbar",
            pagination:true,
            singleSelect:false,
            pageSize:10,
            pageList:[10,20,30,40,50],
            columns:[[
                {field:'_id',checkbox:true},
                {field:'username',title:'用户名',align:"center",width:150},
                {field:'password',title:'密码',align:"center",width:220},
                {field:'status',title:'状态',align:"center",width:70,formatter: function(value,row,index){
                    return value == 0 ? "正常" : "禁用";
                }}
            ]]
        });
    }

</script>
